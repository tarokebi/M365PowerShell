# 1. CSVã‹ã‚‰è¡¨ç¤ºåãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿
$inputList = Import-Csv -Path "names.csv"

# 2. å…ˆã« Get-Recipient ã‚’ä¸€æ‹¬å–å¾—ï¼ˆ1å›ã ã‘ï¼ï¼‰
$allRecipients = Get-Recipient -ResultSize Unlimited

# 3. ç…§åˆã¨ãƒãƒƒãƒ”ãƒ³ã‚°
$result = foreach ($row in $inputList) {
    $displayName = $row.DisplayName

    $match = $allRecipients | Where-Object { $_.DisplayName -eq $displayName }

    if ($match) {
        [PSCustomObject]@{
            DisplayName    = $match.DisplayName
            EmailAddress   = $match.PrimarySmtpAddress
            RecipientType  = $match.RecipientType
            Found          = "Yes"
        }
    } else {
        [PSCustomObject]@{
            DisplayName    = $displayName
            EmailAddress   = ""
            RecipientType  = ""
            Found          = "No"
        }
    }
}

# 4. å‡ºåŠ›
$result | Export-Csv -Path "ResolvedRecipients.csv" -NoTypeInformation -Encoding UTF8

###
$externalEmail = "someone@externaldomain.com"
$matchedGroups = @()

$mailEnabledSecGroups = Get-DistributionGroup -ResultSize Unlimited | Where-Object { $_.GroupType -like "*SecurityEnabled*" }

$total = $mailEnabledSecGroups.Count
$count = 0

foreach ($group in $mailEnabledSecGroups) {
    $count++

    # ğŸŒˆ é€²æ—ãƒãƒ¼è¡¨ç¤º
    Write-Progress -Activity "Checking groups..." `
                   -Status "Checking: $($group.DisplayName)" `
                   -PercentComplete (($count / $total) * 100)

    $members = Get-DistributionGroupMember -Identity $group.Identity -ResultSize Unlimited

    if ($members.PrimarySmtpAddress -contains $externalEmail) {
        $matchedGroups += $group.DisplayName
    }
}

# çµæœã®è¡¨ç¤º
Write-Progress -Activity "Checking groups..." -Completed

if ($matchedGroups.Count -gt 0) {
    Write-Host "`nğŸ“Œ è¦‹ã¤ã‹ã£ãŸã‚°ãƒ«ãƒ¼ãƒ—ä¸€è¦§ï¼š"
    $matchedGroups | ForEach-Object { Write-Host " - $_" }
} else {
    Write-Host "ğŸ” æŒ‡å®šã•ã‚ŒãŸå¤–éƒ¨é€£çµ¡å…ˆã¯ã€ã©ã®ãƒ¡ãƒ¼ãƒ«ãŒæœ‰åŠ¹ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã«ã‚‚å«ã¾ã‚Œã¦ã„ãªã„ã¿ãŸã„ã€‚"
}


