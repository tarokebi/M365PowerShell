# 1. CSVから表示名リストを読み込み
$inputList = Import-Csv -Path "names.csv"

# 2. 先に Get-Recipient を一括取得（1回だけ！）
$allRecipients = Get-Recipient -ResultSize Unlimited

# 3. 照合とマッピング
$result = foreach ($row in $inputList) {
    $displayName = $row.DisplayName

    $match = $allRecipients | Where-Object { $_.DisplayName -eq $displayName }

    if ($match) {
        [PSCustomObject]@{
            DisplayName    = $match.DisplayName
            EmailAddress   = $match.PrimarySmtpAddress
            RecipientType  = $match.RecipientType
            Found          = "Yes"
        }
    } else {
        [PSCustomObject]@{
            DisplayName    = $displayName
            EmailAddress   = ""
            RecipientType  = ""
            Found          = "No"
        }
    }
}

# 4. 出力
$result | Export-Csv -Path "ResolvedRecipients.csv" -NoTypeInformation -Encoding UTF8

###
# 外部連絡先の PrimarySMTPAddress（メールアドレス）を指定
$externalEmail = "someone@externaldomain.com"

# メールが有効なセキュリティ グループをすべて取得
$mailEnabledSecGroups = Get-DistributionGroup -ResultSize Unlimited | Where-Object { $_.GroupType -like "*SecurityEnabled*" }

# 各グループに対して、対象の外部連絡先が含まれているかをチェック
foreach ($group in $mailEnabledSecGroups) {
    $members = Get-DistributionGroupMember -Identity $group.Identity -ResultSize Unlimited
    if ($members.PrimarySmtpAddress -contains $externalEmail) {
        Write-Host "✅ 見つかった！ $externalEmail はグループ '$($group.DisplayName)' に含まれているよ。"
    }
}

