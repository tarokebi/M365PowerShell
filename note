# 1. CSVã‹ã‚‰è¡¨ç¤ºåãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿
$inputList = Import-Csv -Path "names.csv"

# 2. å…ˆã« Get-Recipient ã‚’ä¸€æ‹¬å–å¾—ï¼ˆ1å›ã ã‘ï¼ï¼‰
$allRecipients = Get-Recipient -ResultSize Unlimited

# 3. ç…§åˆã¨ãƒãƒƒãƒ”ãƒ³ã‚°
$result = foreach ($row in $inputList) {
    $displayName = $row.DisplayName

    $match = $allRecipients | Where-Object { $_.DisplayName -eq $displayName }

    if ($match) {
        [PSCustomObject]@{
            DisplayName    = $match.DisplayName
            EmailAddress   = $match.PrimarySmtpAddress
            RecipientType  = $match.RecipientType
            Found          = "Yes"
        }
    } else {
        [PSCustomObject]@{
            DisplayName    = $displayName
            EmailAddress   = ""
            RecipientType  = ""
            Found          = "No"
        }
    }
}

# 4. å‡ºåŠ›
$result | Export-Csv -Path "ResolvedRecipients.csv" -NoTypeInformation -Encoding UTF8

###
# ğŸ”¸ æ¤œç´¢å¯¾è±¡ã®å¤–éƒ¨ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã“ã“ã«é…åˆ—ã§å®šç¾©
$externalEmails = @(
    "one@example.com",
    "two@example.com",
    "three@example.com",
    "four@example.com",
    "five@example.com"
)

# ğŸ”¸ çµæœæ ¼ç´ç”¨ï¼ˆ@{ ã‚¢ãƒ‰ãƒ¬ã‚¹ = [æ‰€å±ã—ã¦ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—åã®é…åˆ—] } ã®å½¢ã§ä¿å­˜ï¼‰
$results = @{}

# ğŸ”¸ å¯¾è±¡ã¨ãªã‚‹ãƒ¡ãƒ¼ãƒ«ãŒæœ‰åŠ¹ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ä¸€è¦§ã‚’å–å¾—
$mailEnabledSecGroups = Get-DistributionGroup -ResultSize Unlimited | Where-Object { $_.GroupType -like "*SecurityEnabled*" }

$total = $mailEnabledSecGroups.Count
$count = 0

foreach ($group in $mailEnabledSecGroups) {
    $count++
    Write-Progress -Activity "Checking groups..." `
                   -Status "Checking: $($group.DisplayName)" `
                   -PercentComplete (($count / $total) * 100)

    $members = Get-DistributionGroupMember -Identity $group.Identity -ResultSize Unlimited

    foreach ($email in $externalEmails) {
        if ($members.PrimarySmtpAddress -contains $email) {
            if (-not $results.ContainsKey($email)) {
                $results[$email] = @()
            }
            $results[$email] += $group.DisplayName
        }
    }
}

Write-Progress -Activity "Checking groups..." -Completed

# ğŸ”¸ çµæœè¡¨ç¤ºï¼
foreach ($email in $externalEmails) {
    Write-Host "`nğŸ“¬ $email ã®æ‰€å±ã‚°ãƒ«ãƒ¼ãƒ—ï¼š"
    if ($results.ContainsKey($email)) {
        $results[$email] | ForEach-Object { Write-Host " - $_" }
    } else {
        Write-Host " - (æ‰€å±ãªã—)"
    }
}

###
# CSV èª­ã¿è¾¼ã¿
$csvContacts = Import-Csv -Path "external_contacts.csv"
$targetContacts = @{}
foreach ($contact in $csvContacts) {
    $trimmedDisplayName = $contact.DisplayName.Trim()
    $targetContacts[$trimmedDisplayName] = $null
}

# å¤–éƒ¨é€£çµ¡å…ˆã‚’å–å¾—
$mailContacts = Get-MailContact -ResultSize Unlimited

# ã‚°ãƒ«ãƒ¼ãƒ—ä¸€è¦§ã‚’å–å¾—
$groups = Get-DistributionGroup -ResultSize Unlimited | Where-Object {
    $_.RecipientTypeDetails -eq "MailUniversalSecurityGroup"
}

# çµæœæ ¼ç´ç”¨
$result = @()

# é€²æ—ãƒãƒ¼è¡¨ç¤ºç”¨ã‚«ã‚¦ãƒ³ã‚¿
$totalGroups = $groups.Count
$index = 0

foreach ($group in $groups) {
    $index++
    
    # é€²æ—ãƒãƒ¼ã®è¡¨ç¤º
    Write-Progress -Activity "Checking Groups" `
                   -Status "Processing '$($group.DisplayName)'" `
                   -PercentComplete (($index / $totalGroups) * 100)

    $members = Get-DistributionGroupMember -Identity $group.Identity -ResultSize Unlimited
    $externalMembers = $members | Where-Object { $_.RecipientType -eq "MailContact" }

    foreach ($member in $externalMembers) {
        $trimmedName = $member.DisplayName.Trim()
        if ($targetContacts.ContainsKey($trimmedName)) {
            $result += [PSCustomObject]@{
                DisplayName        = $member.DisplayName
                Address            = $member.PrimarySmtpAddress
                SecurityGroupName  = $group.DisplayName
                SecurityGroupAlias = $group.Alias
            }
        }
    }
}

# çµæœå‡ºåŠ›
$result | Export-Csv -Path "ExternalContacts_GroupMembership.csv" -NoTypeInformation -Encoding UTF8

# æœ€å¾Œã«é€²æ—ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢ï¼ˆãŠå¥½ã¿ã§ï¼‰
Write-Progress -Activity "Completed" -Status "All groups processed." -Completed



